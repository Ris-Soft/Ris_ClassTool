<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ris_ClassTool</title>
    <link rel="stylesheet" href="./icons/bootstrap-icons.css">
    <style>
        body,
        html {
            background-color: rgb(30, 30, 30);
            color: white;
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            user-select: none;
        }

        .top-section {
            flex: 1;
        }

        .bottom-section {
            background-color: #000000;
            height: 21%;
            display: flex;
            flex-direction: column;
            border-radius: 10px;
            margin: 10px;
        }

        .title-bar {
            display: flex;
            align-items: center;
            padding: 10px;
            background-color: #0e0e0e;
            border-radius: 10px 10px 0 0;
            max-height: 22px;
        }

        .title-bar button {
            margin-right: 10px;
        }

        #title {
            font-weight: 600;
            font-size: 18px;
        }

        .button-container {
            display: flex;
            overflow-x: auto;
            padding: 10px;
            height: 90%;
        }

        .button-container::-webkit-scrollbar {
            height: 8px;
        }

        .button-container::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        .button-container::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .button {
            font-weight: 300;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0 10px;
            padding: 5px 10px;
            cursor: pointer;
            height: auto;
            transition: background-color 0.3s, transform 0.3s;
            border-radius: 5px;
        }

        .button:hover {
            background-color: rgba(255, 255, 255, 0.1);
            transform: scale(1.05);
        }

        .button:active {
            background-color: rgba(255, 255, 255, 0.2);
            transform: scale(0.95);
        }

        .clicked {
            background-color: rgba(255, 255, 255, 0.1);
            transform: scale(1.05);
        }

        .button i {
            font-size: 6vh;
            color: rgb(239, 239, 239);
        }

        .button span {
            margin-top: 5px;
        }

        .main-button {
            min-width: 100px;
            opacity: 0;
            animation: fadeIn 0.5s forwards;
        }

        #back-button {
            background-color: #101010;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.3s;
            margin-top: 0;
            margin-bottom: 0;
        }

        #back-button:hover {
            background-color: #202020;
        }

        #back-button i {
            font-size: 20px;
            font-weight: 600;
            color: white;
        }

        #webview-section {
            display: none;
            height: calc(100% - 10px);
            border-radius: 10px;
            margin: 10px;
            background-color: #000000;
            box-sizing: border-box;
            opacity: 0;
            animation: fadeIn 0.5s forwards;
        }

        @keyframes fadeIn {
            to {
                opacity: 1;
            }
        }

        @keyframes fadeOut {
            to {
                opacity: 0;
            }
        }
    </style>
</head>

<body>
    <div class="top-section" id="top-section">
        <div id="editor-section"
            style="display: flex; justify-content: center; align-items: center; height: 60%; color: #4d4d4d">
            拖动组件可改变组件位置
        </div>
        <div id="webview-section">
            <div class="title-bar">
                <span id="webview-title"></span>
            </div>
            <webview src="" style="width: 100%; height: calc(100% - 22px); border: none; color: white;"></webview>
            <script>
                const webview = document.querySelector('webview');
                webview.addEventListener('did-finish-load', () => {
                    webview.executeJavaScript('document.title').then(title => {
                        document.getElementById('webview-title').innerText = title || 'Loaded';
                    });
                });
            </script>
        </div>
    </div>
    <div class="bottom-section">
        <div class="title-bar">
            <button id="back-button" class="button" style="display: none;" onclick="goBack()"><i
                    class="bi bi-arrow-left"></i></button>
            <span id="title">Ris_ClassTool</span>
        </div>
        <div class="button-container" id="button-container"></div>
    </div>

    <script>
        // const { icpMain, ipcRenderer } = nodeRequire('electron');

        const buttons = [
            {
                icon: 'question-circle',
                text: '使用说明',
                sub: [
                    {
                        type: 'cloudGet',
                        url: 'https://classtool.3r60.top/api/help/helpMenu.json',
                    }
                ],
            },
            {
                icon: 'list-nested',
                text: '时间与课程',
                sub: [
                    {
                        icon: 'calendar-event',
                        text: '临时调课',
                        sub: [
                            {
                                icon: 'calendar-day',
                                text: '周一'
                            },
                            {
                                icon: 'calendar-day',
                                text: '周二'
                            },
                            {
                                icon: 'calendar-day',
                                text: '周三'
                            },
                            {
                                icon: 'calendar-day',
                                text: '周四'
                            },
                            {
                                icon: 'calendar-day',
                                text: '周五'
                            },
                            {
                                icon: 'calendar-day',
                                text: '周六'
                            },
                            {
                                icon: 'calendar-day',
                                text: '周日'
                            }
                        ]
                    },
                    {
                        icon: 'clock',
                        text: '时间表',
                        sub: [
                            {
                                icon: 'sun',
                                text: '夏季(当前)'
                            },
                            {
                                icon: 'cloud',
                                text: '秋季'
                            },
                            {
                                icon: 'plus-circle',
                                text: '附加'
                            },
                            {
                                icon: 'pencil',
                                text: '编辑时间表'
                            }
                        ]
                    },
                    {
                        icon: 'table',
                        text: '课程表',
                        sub: [
                            {
                                icon: 'arrows-move',
                                text: '模式:单双周'
                            },
                            {
                                icon: 'pencil-square',
                                text: '打开编辑器'
                            }
                        ]
                    },
                    {
                        icon: 'file-earmark-arrow-up',
                        text: '导入与导出',
                        sub: [
                            {
                                icon: 'file-earmark-excel',
                                text: '导入Excel'
                            },
                            {
                                icon: 'file-earmark-arrow-up',
                                text: '导入UCSF'
                            },
                            {
                                icon: 'file-earmark-excel',
                                text: '导出Excel'
                            },
                            {
                                icon: 'file-earmark-arrow-down',
                                text: '导出UCSF'
                            }
                        ]
                    }
                ]
            },
            {
                icon: 'calendar',
                text: '日期与时间'
            },
            {
                icon: 'shop',
                text: '组件市场'
            },
            {
                icon: 'palette',
                text: '外观设定'
            },
            {
                icon: 'info-circle',
                text: '关于软件'
            },
            {
                icon: 'sliders',
                text: '侧边栏设定'
            },
            {
                icon: 'box-arrow-right',
                text: '退出设置',
                onclick: `() => {
                    window.close();
                }`
            }
        ];
        let currentButtons = buttons;
        let history = [];
        let CommonentLayer = true;

        async function fetchButtonsFromCloud(url) {
            try {
                const response = await fetch(`${url}?timestamp=${new Date().getTime()}`);
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                const data = await response.json();
                return data;
            } catch (error) {
                return [
                    {
                        icon: 'exclamation-triangle',
                        text: '获取失败'
                    }
                ];
            }
        }

        async function loadButtons(buttons) {
            const container = document.getElementById('button-container');
            container.innerHTML = '';
            for (const [index, button] of buttons.entries()) {
                const btn = document.createElement('div');
                btn.className = 'button main-button';
                btn.innerHTML = `<i class="bi bi-${button.icon}"></i><span>${button.text}</span>`;
                btn.style.animationDelay = `${index * 0.1}s`;
                btn.onclick = async () => {
                    if (button.sub) {
                        if (button.sub[0].type === 'cloudGet') {
                            const cloudButtons = await fetchButtonsFromCloud(button.sub[0].url);
                            document.getElementById('title').innerText = button.text;
                            history.push(currentButtons);
                            currentButtons = cloudButtons;
                            document.getElementById('back-button').style.display = 'inline';
                            loadButtons(cloudButtons);
                        } else {
                            document.getElementById('title').innerText = button.text;
                            history.push(currentButtons);
                            currentButtons = button.sub;
                            document.getElementById('back-button').style.display = 'inline';
                            loadButtons(button.sub);
                        }
                    } else {
                        const buttons = document.getElementsByClassName('button main-button');
                        for (let i = 0; i < buttons.length; i++) {
                            buttons[i].className = 'button main-button';
                        }
                        btn.className = 'button main-button clicked';
                    }
                    if (button.onclick) excuteFunc(button.onclick);
                };
                container.appendChild(btn);
            }
        }

        function goBack() {
            toggleTopSection('editor');
            if (history.length > 0) {
                currentButtons = history.pop();
                document.getElementById('title').innerText = history.length > 0 ? history[history.length - 1][0].text : 'Ris_ClassTool';
                loadButtons(currentButtons);
                if (history.length === 0) {
                    document.getElementById('back-button').style.display = 'none';
                }
            }
        }

        loadButtons(buttons);

        // 处理文本函数
        function excuteFunc(funcOrString, ...args) {
            if (typeof funcOrString === 'function') {
                return funcOrString(...args);
            }
            if (typeof funcOrString !== 'string') {
                throw new Error('The first argument must be a string or a function.');
            }
            funcOrString = funcOrString.trim();
            const isArrowFunction = funcOrString.startsWith('(') || funcOrString.startsWith('function');
            if (!isArrowFunction) {
                throw new Error('Invalid function string. It must be in the form of "(args) => { ... }" or "function(args) => { ... }".');
            }
            let params = '';
            let body = '';
            if (funcOrString.startsWith('function')) {
                const match = funcOrString.match(/function\s*\(([^)]*)\)\s*=>\s*({[^}]*})/);
                if (match) {
                    params = match[1];
                    body = match[2];
                } else {
                    throw new Error('Invalid function format. Expected "function(args) => { ... }".');
                }
            } else {
                const match = funcOrString.match(/\(([^)]*)\)\s*=>\s*({[^}]*})/);
                if (match) {
                    params = match[1];
                    body = match[2];
                } else {
                    throw new Error('Invalid function format. Expected "(args) => { ... }".');
                }
            }
            const func = new Function(params, body);
            return func(...args);
        }

        function toggleTopSection(mode) {
            const editorSection = document.getElementById('editor-section');
            const webviewSection = document.getElementById('webview-section');
            const webview = webviewSection.querySelector('webview');

            if (mode === 'editor') {
                editorSection.style.display = 'flex';
                webviewSection.style.display = 'none';
                window.api.config_settingPage("show");
            } else if (mode.startsWith('https://')) {
                window.api.config_settingPage("hide");
                editorSection.style.display = 'none';
                webviewSection.style.display = 'block';
                webview.src = mode;
            } else {
                console.error('Invalid mode provided to toggleTopSection');
            }
        }
    </script>
</body>

</html>