<!DOCTYPE html>
<html lang="zh-CN">
<!--<div style="position: fixed; right: 0; bottom: 0; padding: 20px; font-family: Arial, sans-serif; color: #666;z-index:1000">
    <b>RisClassTool</b><br>Insider Preview
</div>-->

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>设置</title>
    <link rel="stylesheet" href="./icons/bootstrap-icons.css">
    <!--<link rel="stylesheet" href="https://assets.3r60.top/icons/bootstrap-icons.css">-->
    <script src="./js/xlsx.js"></script>
    <link rel="stylesheet" href="./styles/set.css">
</head>

<body>
    <div id="header">
        <div class="title"><i class="bi bi-gear"></i>&nbsp;程序设置</div>
    </div>
    <div id="sidebar">
        <div class="sidebar-item active" data-target="#control"><i class="bi bi-toggle2-off"></i>&nbsp;功能开关</div>
        <div class="sidebar-item" data-target="#basic"><i class="bi bi-gear"></i>&nbsp;通用选项</div>
        <div class="sidebar-item" data-target="#autoQuit"><i class="bi bi-code-square"></i>&nbsp;计划任务</div>
        <div class="sidebar-item" data-target="#appearance"><i class="bi bi-palette"></i>&nbsp;外观设置</div>
        <div class="sidebar-item" data-target="#countdown"><i class="bi bi-clock"></i>&nbsp;倒计时与天气</div>
        <div class="sidebar-item" data-target="#sidebarSettings"><i class="bi bi-layout-sidebar"></i>&nbsp;侧边栏设置</div>
        <div class="sidebar-item" data-target="#about"><i class="bi bi-info-circle"></i>&nbsp;关于程序</div>
    </div>
    </div>
    <div id="main-content">
        <!--功能开关页面-->
        <div class="content-page active" id="control">
            <div class="page-title"><i class="bi bi-gear"></i>&nbsp;功能开关</div>
            <div style="display: flex; flex-wrap: wrap;">
                <div class="card-toggle" id="desktopLayerCard">
                    <div class="icon" onclick="toggleFeature('desktopLayer')"><i class="bi bi-display"></i></div>
                    <div class="divider"></div>
                    <div class="footer">
                        <span class="title">桌面组件</span>
                        <i class="bi bi-gear settings"></i>
                    </div>
                </div>
                <div class="card-toggle" id="statusLayerCard">
                    <div class="icon" onclick="toggleFeature('statusLayer')"><i class="bi bi-window"></i></div>
                    <div class="divider"></div>
                    <div class="footer">
                        <span class="title">状态窗口</span>
                        <i class="bi bi-gear settings"></i>
                    </div>
                </div>
                <div class="card-toggle" id="processLayerCard">
                    <div class="icon" onclick="toggleFeature('processLayer')"><i class="bi bi-bar-chart"></i></div>
                    <div class="divider"></div>
                    <div class="footer">
                        <span class="title">顶部进度条</span>
                        <i class="bi bi-gear settings"></i>
                    </div>
                </div>
                <div class="card-toggle" id="pptHelperCard">
                    <div class="icon" onclick="toggleFeature('pptHelper')"><i class="bi bi-easel"></i></div>
                    <div class="divider"></div>
                    <div class="footer">
                        <span class="title">PPT助手</span>
                        <i class="bi bi-gear settings"></i>
                    </div>
                </div>
            </div>
            <br>
            *点击卡片切换功能开关<br>
        </div>
        <!-- 外观设置页面 -->
        <div class="content-page" id="appearance">
            <div class="page-title"><i class="bi bi-palette"></i>&nbsp;外观设置</div>
            <div class="card">
                <label for="progressColor">
                    <h2>主题颜色</h2>进度条与课程表的突出主题色
                </label>
                <input type="text" id="progressColor" placeholder="默认值：#1E9FFF"><br><br>
            </div>
            <div class="card">
                <label for="scheduleFontSize">
                    <h2>桌面课程字体设定</h2>课程表相对字体大小等级[推荐值：1]
                </label>
                <input type="text" id="scheduleFontSize" placeholder="推荐值：1"><br><br>
            </div>
            <div class="card">
                <label for="infoFontSize">
                    <h2>桌面信息窗字体设定</h2>桌面信息窗相对字体大小等级，不填写默认跟随课程表字体大小
                </label>
                <input type="text" id="infoFontSize" placeholder="推荐值：1"><br><br>
            </div>
            <div class="card">
                <label for="progressHeight">
                    <h2>进度条高度</h2>顶部进度条的显示高度，最大值为100px
                </label>
                <input type="text" id="progressHeight" placeholder="默认值：2px"><br><br>
            </div>
            <div class="card" style="display: block;">
                <label style="margin-bottom: 5px;">
                    <h2>桌面学科课程图标</h2>在桌面创建文件夹并更改为精美图标，已创建的文件夹不影响内容
                </label>
                <button type="button" onclick="window.api.function_desktopIcon()">立即创建</button>
            </div>
        </div>
        <!-- 倒计时与提醒页面 -->
        <div class="content-page" id="countdown">
            <div class="page-title"><i class="bi bi-clock"></i>&nbsp;倒计时与提醒</div>
            <div class="card">
                <label for="posName">
                    <h2>地理位置</h2>用于获取天气信息，关闭倒数日时生效
                </label>
                <input type="text" id="posName" placeholder="位置名称"><br><br>
            </div>
        </div>
        <!-- 侧边栏设置页面 -->
        <div class="content-page" id="sidebarSettings">
            <div class="page-title"><i class="bi bi-layout-sidebar"></i>&nbsp;侧边栏设置</div>
            <div class="card">
                <label for="sideBarShow">
                    <h2>启用侧边栏</h2>实时生效，关闭后则不再创建侧边栏窗口
                </label>
                <input onchange="saveConfigOnBlur(this)" type="checkbox" id="sideBarShow"><br>
            </div>
            <div class="card">
                <label for="sideBarBottom">
                    <h2>侧边栏位置</h2>侧边栏按钮与底部距离，重启后生效
                </label>
                <input type="text" id="sideBarBottom" placeholder="默认值：200"><br><br>
            </div>
        </div>
        <!-- 基本设置页面 -->
        <div class="content-page" id="basic">
            <div class="page-title"><i class="bi bi-gear"></i>&nbsp;通用设定</div>
            <form id="basicSettingsForm">
                <div class="card">
                    <label for="startDate">
                        <h2>学期开始时间</h2>用于进行单双周判断
                    </label>
                    <input type="text" id="startDate" placeholder="学期开始时间"><br><br>
                </div>
                <div class="card" style="display: none;">
                    <label for="insiderPreview">
                        <h2>预览体验成员</h2>开启后可视化页面将交给瑞思软件的服务器接管（服务器连接失败时使用本地连接）[重启软件后生效]
                    </label>
                    <input onchange="saveConfigOnBlur(this)" type="checkbox" id="insiderPreview"><br>
                </div>
                <div class="card">
                    <label for="cloudUrl">
                        <h2>云配置地址</h2>设置后每次启动将尝试用链接中的文本替代配置
                    </label>
                    <input type="text" id="cloudUrl" placeholder="云配置地址"><br><br>
                </div>
                <div class="card">
                    <label for="timeOffset">
                        <h2>时间偏移</h2>程序内时间偏移，以秒为单位例如：+10或-10
                    </label>
                    <input type="text" id="timeOffset" placeholder="时间偏移，默认0"><br><br>
                </div>
                <div class="card">
                    <label for="focusText">
                        <h2>专注模式默认文本</h2>专注模式默认文本，留空则不显示，处于专注模式时可单击文字暂时修改
                    </label>
                    <input type="text" id="focusText" placeholder="专注模式默认文本"><br><br>
                </div>
                <!-- <div class="card">
                <button type="button" id="saveAutoQuitConfigButton" onclick="saveBasicConfigButton()">保存</button>
            </div> -->
            </form>
        </div>
        <!--自动任务配置页面-->
        <div class="content-page" id="autoQuit">
            <div class="page-title"><i class="bi bi-code-square"></i>&nbsp;自动执行</div>
            <form id="autoQuitSettingsForm">
                <div class="card">
                    <label for="playNotify">
                        <h2>播放上下课提示音</h2>距离上课0秒或下课前1秒播放音频
                    </label>
                    <input onchange="saveConfigOnBlur(this)" type="checkbox" id="playNotify">
                </div>
                <div class="card">
                    <label for="autoQuit">
                        <h2>课前5分钟准备</h2>课前五分钟时倒计时提示关闭清单内程序
                    </label>
                    <input onchange="saveConfigOnBlur(this)" type="checkbox" id="autoQuit">
                </div>
                <div class="card">
                    <label for="autoOpenFolder">
                        <h2>上课时自动打开相应学科文件夹</h2>仅支持文件夹在桌面时
                    </label>
                    <input onchange="saveConfigOnBlur(this)" type="checkbox" id="autoOpenFolder">
                </div>
                <div class="card">
                    <label for="autoFocusMode">
                        <h2>自习课自动进入专注模式</h2>当课程为“自”时，会自动进入专注模式
                    </label>
                    <input onchange="saveConfigOnBlur(this)" type="checkbox" id="autoFocusMode">
                </div>
                <div class="card">
                    <label for="autoFocusMode_PE">
                        <h2>体育课自动进入专注模式</h2>当课程为“体”时，会自动进入专注模式
                    </label>
                    <input onchange="saveConfigOnBlur(this)" type="checkbox" id="autoFocusMode_PE">
                </div>
                <div class="card">
                    <label for="autoPowerOffB">
                        <h2>空白课程关机</h2>当课程为“-”时，会提示并倒计时自动工具
                    </label>
                    <input onchange="saveConfigOnBlur(this)" type="checkbox" id="autoPowerOffB">
                </div>
                <div class="card">
                    <label for="autoPowerOff">
                        <h2>放学自动关机</h2>当天最后一节课结束后倒计时关闭计算机
                    </label>
                    <input onchange="saveConfigOnBlur(this)" type="checkbox" id="autoPowerOff">
                </div>
                <!-- <div class="card">
                <button type="button" id="saveBasicConfigButton" onclick="saveAutoQuitConfigButton()">保存</button>
            </div> -->
            </form>
        </div>
        <!--关于页面-->
        <div class="content-page" id="about">
            <div class="about-container">
                <h1><i class="bi bi-info-circle"></i> RisClassTool <span id="version"></span></h1>
                <h3><i class="bi bi-gear"></i> 瑞思课堂工具 - 教室桌面得力助手</h3>
                <ul class="about-list">
                    <li><strong>使用提示：</strong></li>
                    <li><i class="bi bi-exclamation-triangle"></i> 请不要使用管理员权限运行本程序</li>
                    <li><i class="bi bi-circle"></i> 本程序启动时会自动尝试设置开机自启动，无需自行操作</li>
                    <li><i class="bi bi-geo-alt"></i> 在通用设置中填写位置名称时，请提供详细地址，以避免因重名地点导致获取信息出错</li>
                    <li><i class="bi bi-folder"></i> 配置文件存储于 D:/Ris_ClassToolConfig.json，请在删除文件时注意备份</li>
                    <li><i class="bi bi-clock"></i> 数据刷新间隔：进度条每1秒刷新一次；课程表每10秒刷新一次；天气信息每10分钟更新一次</li>
                    <li><i class="bi bi-telegram"></i> 如遇更多问题，请加入官方群组：939571490</li>
                </ul>
                <div class="about-footer">
                    <p>&copy; 2024 瑞思课堂工具</p>
                </div>
            </div>
        </div>
    </div>

    <script src="./js/pinyin-pro.js"></script>
    <script>
        var Config;

        function init(config) {
            console.log('配置传入:', config);
            document.getElementById('version').innerHTML = config.version;
            document.getElementById('posName').value = config.posName || '';
            document.getElementById('progressColor').value = config.progressColor || '';
            document.getElementById('sideBarShow').checked = config.sideBarShow ?? true;
            document.getElementById('sideBarBottom').value = config.sideBarBottom || '';
            document.getElementById('scheduleFontSize').value = config.scheduleFontSize || '';
            document.getElementById('infoFontSize').value = config.infoFontSize || '';
            document.getElementById('progressHeight').value = config.progressHeight || '';
            document.getElementById('timeOffset').value = config.timeOffset || '';
            document.getElementById('cloudUrl').value = config.cloudUrl || '';
            document.getElementById('focusText').value = config.focusText || '';
            document.getElementById('startDate').value = config.startDate || '';
            document.getElementById('playNotify').value = config.playNotify || true;
            document.getElementById('autoQuit').checked = config.autoQuit ?? true;
            document.getElementById('autoPowerOff').checked = config.autoPowerOff ?? true;
            document.getElementById('autoFocusMode').checked = config.autoFocusMode ?? true;
            document.getElementById('autoFocusMode_PE').checked = config.autoFocusMode_PE ?? true;
            document.getElementById('insiderPreview').checked = config.insiderPreview ?? false;
            document.getElementById('autoPowerOffB').checked = config.autoPowerOffB ?? false;
            document.getElementById('pptHelperCard').classList.toggle('active', config.pptHelper ?? true);
            document.getElementById('desktopLayerCard').classList.toggle('active', config.desktopLayer ?? true);
            document.getElementById('statusLayerCard').classList.toggle('active', config.statusLayer ?? true);
            document.getElementById('processLayerCard').classList.toggle('active', config.processLayer ?? true);
            document.getElementById('autoOpenFolder').checked = config.autoOpenFolder ?? false;

            if (config.cloudUrl) {
                alert('云配置已接管所有设置，若不更改云配置设置下次启动时会被云配置覆盖！');
            }

            Config = config;
        }

        window.api.config_onRecive(init);

        document.querySelectorAll('input, select, textarea').forEach(element => {
            element.addEventListener('blur', function () {
                saveConfigOnBlur(this);
            });
        });

        window.onload = async () => {
            init(await window.api.config_Get(false));
            const targetPage = await window.api.config_settingPage();
            if (targetPage) {
                const targetId = targetPage;
                document.querySelectorAll('.content-page').forEach(page => {
                    page.classList.remove('active');
                });
                document.querySelector(targetId).classList.add('active');
                document.querySelectorAll('.sidebar-item').forEach(i => i.classList.remove('active'));
                this.classList.add('active');
            }
        };

        // 新增功能开关切换逻辑
        function toggleFeature(featureId) {
            const card = document.getElementById(`${featureId}Card`);
            const isActive = card.classList.toggle('active');
            const config = {};
            config[featureId] = isActive;
            window.api.config_save(config);
        }
    </script>
    <script src="./js/settings/data.js"></script>
    <script src="./js/settings/schedule.js"></script>
    <script src="./js/settings/students.js"></script>
    <script src="./js/settings/tools.js"></script>
    <script src="./js/settings/ui.js"></script>
</body>

</html>